CREATE TABLE
    fiskeridir_ais_vessel_mapping_whitelist (
        fiskeridir_vessel_id BIGINT REFERENCES fiskeridir_vessels (fiskeridir_vessel_id) ON DELETE CASCADE PRIMARY KEY,
        call_sign VARCHAR CHECK (call_sign <> ''),
        mmsi INT REFERENCES ais_vessels (mmsi) ON DELETE CASCADE,
        is_manual BOOLEAN NOT NULL DEFAULT FALSE
    );

CREATE TABLE
    fiskeridir_ais_vessel_active_conflicts (
        call_sign VARCHAR CHECK (call_sign <> '') PRIMARY KEY,
        fiskeridir_vessel_ids BIGINT[] DEFAULT '{}' NOT NULL,
        mmsis INT[] DEFAULT '{}' NOT NULL,
        ais_vessel_names VARCHAR[] DEFAULT '{}' NOT NULL,
        fiskeridir_vessel_names VARCHAR[] DEFAULT '{}' NOT NULL,
        fiskeridir_vessel_source_ids INT[] DEFAULT '{}' NOT NULL
    );

ALTER TABLE fiskeridir_vessels
ADD COLUMN overriden_call_sign VARCHAR;

ALTER TABLE fiskeridir_vessels
ADD COLUMN call_sign_override BOOLEAN NOT NULL DEFAULT FALSE;

CREATE INDEX ON fiskeridir_ais_vessel_mapping_whitelist (is_manual);

CREATE INDEX ON fiskeridir_ais_vessel_mapping_whitelist (mmsi);

CREATE INDEX ON fiskeridir_ais_vessel_mapping_whitelist (call_sign);

UPDATE fiskeridir_vessels
SET
    call_sign = q.call_sign,
    overriden_call_sign = fiskeridir_vessels.call_sign,
    call_sign_override = TRUE
FROM
    (
        SELECT
            qi.fiskeridir_vessel_id,
            (
                ARRAY_AGG(
                    vessel_call_sign
                    ORDER BY
                        qi.landing_ids DESC
                )
            ) [1] AS call_sign
        FROM
            (
                SELECT
                    fiskeridir_vessel_id,
                    vessel_call_sign,
                    COUNT(landing_id) AS landing_ids
                FROM
                    landings
                WHERE
                    vessel_call_sign IS NOT NULL
                    AND NOT (vessel_call_sign = ANY ('{00000000, 0}'))
                GROUP BY
                    fiskeridir_vessel_id,
                    vessel_call_sign
            ) qi
        GROUP BY
            qi.fiskeridir_vessel_id
        HAVING
            COUNT(DISTINCT vessel_call_sign) > 1
    ) q
WHERE
    fiskeridir_vessels.call_sign = q.call_sign
    AND fiskeridir_vessel_source_id = 1;

INSERT INTO
    ais_vessels (mmsi)
VALUES
    (259154000),
    (259017500),
    (259017500),
    (258559000),
    (258559000),
    (257271600),
    (257656000),
    (257001420),
    (257004760),
    (257058300),
    (257093370),
    (257665700),
    (257746600),
    (257566000),
    (259252000),
    (257134620),
    (257714600),
    (257736500),
    (257736500),
    (257105640),
    (257130240),
    (257518600),
    (257518600),
    (257024540),
    (257045940),
    (257821500),
    (257074740),
    (257092640),
    (257253620),
    (257989500),
    (257290720),
    (257686600),
    (257686600),
    (257108840),
    (257329920),
    (257361220),
    (257109440),
    (257390920),
    (257163640),
    (257416720),
    (257210940),
    (257465320),
    (259281000),
    (259281000),
    (257435500)
ON CONFLICT DO NOTHING;

INSERT INTO
    fiskeridir_vessels (fiskeridir_vessel_id)
VALUES
    (1996000879),
    (2003021305),
    (1996012073),
    (2001016361),
    (1997000888),
    (2003019681),
    (1995008842),
    (2008044989),
    (1999003650),
    (2011055009),
    (2008044028),
    (2023123977),
    (2008043350),
    (2022123518),
    (2012060972),
    (2013063493),
    (1963008513),
    (2008044409),
    (1998006890),
    (2001016242),
    (1992003937),
    (1980004845),
    (2001015761),
    (1981000430),
    (2017077293),
    (2011054471),
    (2017094633),
    (1997004045),
    (2019109273),
    (2020113273),
    (2014066372),
    (2015071616),
    (2020112733),
    (2023124397),
    (2023124415),
    (1998008635),
    (2010051068),
    (2013063672),
    (1999012077),
    (2002018801),
    (1999010173),
    (1998005448),
    (1995008486),
    (2008043369),
    (2009045868),
    (1997002877),
    (1997000416),
    (1995002251),
    (1998002287),
    (2003021745),
    (2005033025),
    (2001015781),
    (1999002396),
    (1997002252),
    (2003022105),
    (1994001684),
    (2012056808),
    (1996009004),
    (2012057369),
    (1997001922),
    (2001015424),
    (1997000860),
    (2003021665),
    (2004028145),
    (1995002269),
    (1996006444),
    (2003021005),
    (1998002288),
    (2000013317),
    (2011054648),
    (1994008207),
    (2000000330),
    (2001014982),
    (2009046629),
    (1999001563),
    (2004027846),
    (1985003867),
    (1978012088),
    (1992006505),
    (2015071275),
    (1992010604),
    (1974011837),
    (1996006482),
    (2000013406),
    (1991008258),
    (2003021465),
    (1996006832),
    (2003020025),
    (1996006978),
    (1999004927),
    (1989003803),
    (2009046288),
    (1999000089),
    (2003022067),
    (1995007887),
    (1987005566),
    (1964008350),
    (1998004312),
    (1997007170),
    (2001014361),
    (1996006765),
    (1994006318),
    (1998006587),
    (2000013479),
    (1981002501),
    (2010051209),
    (1989007793),
    (2005033647),
    (1992003683),
    (2002017003),
    (1978012266),
    (2001015043),
    (1999000488),
    (2001015426),
    (1999007276),
    (2002016763),
    (1996006390),
    (2003025505),
    (1997000152),
    (2001015046),
    (1995010800),
    (2003021485),
    (2016071933),
    (2001015801),
    (1999011251),
    (2003020765),
    (1994005060),
    (1988005634),
    (1996005387),
    (2004028445),
    (2010050389),
    (1984011652),
    (1983000872),
    (2003021265),
    (1996005835),
    (2000013451),
    (1987006724),
    (2003022505),
    (1999000150),
    (1979002118),
    (1996000257),
    (2004026825),
    (1996003549),
    (2004030606),
    (1995000157),
    (1997001616),
    (2002019301),
    (1992008825),
    (2010049868),
    (1987000616),
    (2003019801),
    (1998009164),
    (2000013619),
    (2003022205),
    (2021119177),
    (1983002899),
    (2002019101),
    (1993010778),
    (1996010718),
    (1985007410),
    (1997005974)
ON CONFLICT DO NOTHING;

INSERT INTO
    fiskeridir_ais_vessel_mapping_whitelist (call_sign, fiskeridir_vessel_id, mmsi, is_manual)
VALUES
    ('3YHR', 1996000879, NULL, TRUE),
    (NULL, 2003021305, NULL, TRUE),
    ('3YOT', 1996012073, NULL, TRUE),
    (NULL, 2001016361, NULL, TRUE),
    ('JXVP', 1997000888, 259154000, TRUE),
    (NULL, 2003019681, NULL, TRUE),
    ('LA4365', 1995008842, NULL, TRUE),
    (NULL, 2008044989, NULL, TRUE),
    ('LA9778', 1999003650, NULL, TRUE),
    ('LA9778', 2011055009, NULL, TRUE),
    ('LCGQ', 2008044028, 259017500, TRUE),
    ('LCGQ', 2023123977, 259017500, TRUE),
    ('LCGV', 2008043350, 258559000, TRUE),
    ('LCGV', 2022123518, 258559000, TRUE),
    ('LDBT', 2012060972, 257271600, TRUE),
    ('LDDF', 2013063493, 257656000, TRUE),
    ('LDQK', 1963008513, NULL, TRUE),
    (NULL, 2008044409, NULL, TRUE),
    ('LEDM', 1998006890, NULL, TRUE),
    (NULL, 2001016242, NULL, TRUE),
    ('LE5942', 1992003937, NULL, TRUE),
    (NULL, 1980004845, NULL, TRUE),
    ('LF3796', 2001015761, NULL, TRUE),
    (NULL, 1981000430, NULL, TRUE),
    ('LF5276', 2017077293, 257001420, TRUE),
    (NULL, 2011054471, NULL, TRUE),
    ('LF5429', 2017094633, 257004760, TRUE),
    (NULL, 1997004045, NULL, TRUE),
    ('LF6343', 2019109273, 257058300, TRUE),
    ('LFRA', 2020113273, 257093370, TRUE),
    ('LG8426', 2014066372, 257665700, TRUE),
    ('LG8754', 2015071616, 257746600, TRUE),
    ('LGFV', 2020112733, 257566000, TRUE),
    ('LH5944', 2023124397, NULL, TRUE),
    ('LH5944', 2023124415, NULL, TRUE),
    ('LJBT', 1998008635, NULL, TRUE),
    (NULL, 2010051068, NULL, TRUE),
    ('LJWI', 2013063672, 259252000, TRUE),
    ('LK2139', 1999012077, NULL, TRUE),
    (NULL, 2002018801, NULL, TRUE),
    ('LK2477', 1999010173, NULL, TRUE),
    (NULL, 1998005448, NULL, TRUE),
    ('LK2716', 1995008486, 257134620, TRUE),
    ('LF4212', 2008043369, NULL, TRUE),
    ('LK3534', 2009045868, NULL, TRUE),
    (NULL, 1997002877, NULL, TRUE),
    ('LK3764', 1997000416, NULL, TRUE),
    (NULL, 1995002251, NULL, TRUE),
    ('LK3989', 1998002287, NULL, TRUE),
    (NULL, 2003021745, NULL, TRUE),
    ('LK4248', 2005033025, 257714600, TRUE),
    ('LK4327', 2001015781, 257736500, TRUE),
    ('LK4327', 1999002396, 257736500, TRUE),
    ('LK4735', 1997002252, 257105640, TRUE),
    (NULL, 2003022105, NULL, TRUE),
    ('LK5299', 1994001684, 257130240, TRUE),
    (NULL, 2012056808, NULL, TRUE),
    ('LK5304', 1996009004, NULL, TRUE),
    ('LF5304', 2012057369, NULL, TRUE),
    ('LK5341', 1997001922, NULL, TRUE),
    (NULL, 2001015424, NULL, TRUE),
    ('LK5588', 1997000860, NULL, TRUE),
    (NULL, 2003021665, NULL, TRUE),
    ('LK5647', 2004028145, 257518600, TRUE),
    ('LK5647', 1995002269, 257518600, TRUE),
    ('LK5749', 1996006444, 257024540, TRUE),
    (NULL, 2003021005, NULL, TRUE),
    ('LK6225', 1998002288, 257045940, TRUE),
    ('LK2530', 2000013317, NULL, TRUE),
    ('LK6241', 2011054648, 257821500, TRUE),
    (NULL, 1994008207, NULL, TRUE),
    ('LK6907', 2000000330, 257074740, TRUE),
    ('LK7369', 2001014982, 257092640, TRUE),
    (NULL, 2009046629, NULL, TRUE),
    ('LM2189', 1999001563, NULL, TRUE),
    (NULL, 2004027846, NULL, TRUE),
    ('LM2413', 1985003867, NULL, TRUE),
    (NULL, 1978012088, NULL, TRUE),
    ('LM2419', 1992006505, NULL, TRUE),
    (NULL, 2015071275, NULL, TRUE),
    ('LM2869', 1992010604, NULL, TRUE),
    (NULL, 1974011837, NULL, TRUE),
    ('LM2901', 1996006482, NULL, TRUE),
    (NULL, 2000013406, NULL, TRUE),
    ('LM4020', 1991008258, NULL, TRUE),
    (NULL, 2003021465, NULL, TRUE),
    ('LM4049', 1996006832, NULL, TRUE),
    (NULL, 2003020025, NULL, TRUE),
    ('LM4085', 1996006978, NULL, TRUE),
    (NULL, 1999004927, NULL, TRUE),
    ('LM4307', 1989003803, 257253620, TRUE),
    (NULL, 2009046288, NULL, TRUE),
    ('LM4537', 1999000089, 257989500, TRUE),
    (NULL, 2003022067, NULL, TRUE),
    ('LM4586', 1995007887, NULL, TRUE),
    ('LK2972', 1987005566, NULL, TRUE),
    ('LM4851', 1964008350, NULL, TRUE),
    ('LGON', 1998004312, NULL, TRUE),
    ('LM4854', 1997007170, NULL, TRUE),
    (NULL, 2001014361, NULL, TRUE),
    ('LM5041', 1996006765, NULL, TRUE),
    (NULL, 1994006318, NULL, TRUE),
    ('LM5416', 1998006587, 257290720, TRUE),
    (NULL, 2000013479, NULL, TRUE),
    ('LM5784', 1981002501, 257686600, TRUE),
    ('LM5784', 2010051209, 257686600, TRUE),
    ('LM5848', 1989007793, 257108840, TRUE),
    (NULL, 2005033647, NULL, TRUE),
    ('LM6348', 1992003683, 257329920, TRUE),
    (NULL, 2002017003, NULL, TRUE),
    ('LM6394', 1978012266, NULL, TRUE),
    ('LF3883', 2001015043, NULL, TRUE),
    ('LM6411', 1999000488, NULL, TRUE),
    (NULL, 2001015426, NULL, TRUE),
    ('LM6716', 1999007276, NULL, TRUE),
    (NULL, 2002016763, NULL, TRUE),
    ('LM7112', 1996006390, 257361220, TRUE),
    (NULL, 2003025505, NULL, TRUE),
    ('LM7131', 1997000152, NULL, TRUE),
    (NULL, 2001015046, NULL, TRUE),
    ('LM7276', 1995010800, NULL, TRUE),
    (NULL, 2003021485, NULL, TRUE),
    ('LM7288', 2016071933, NULL, TRUE),
    (NULL, 2001015801, NULL, TRUE),
    ('LM7577', 1999011251, NULL, TRUE),
    (NULL, 2003020765, NULL, TRUE),
    ('LM7732', 1994005060, 257109440, TRUE),
    ('LM7786', 1988005634, 257390920, TRUE),
    ('LM7958', 1996005387, 257163640, TRUE),
    (NULL, 2004028445, NULL, TRUE),
    ('LM8182', 2010050389, NULL, TRUE),
    ('LM8382', 1984011652, NULL, TRUE),
    ('LM8356', 1983000872, 257416720, TRUE),
    (NULL, 2003021265, NULL, TRUE),
    ('LM8828', 1996005835, NULL, TRUE),
    (NULL, 2000013451, NULL, TRUE),
    ('LM8902', 1987006724, NULL, TRUE),
    (NULL, 2003022505, NULL, TRUE),
    ('LM8974', 1999000150, NULL, TRUE),
    ('LM6893', 1979002118, NULL, TRUE),
    ('LM9032', 1996000257, NULL, TRUE),
    (NULL, 2004026825, NULL, TRUE),
    ('LM9047', 1996003549, NULL, TRUE),
    (NULL, 2004030606, NULL, TRUE),
    ('LM9220', 1995000157, 257210940, TRUE),
    ('LM9390', 1997001616, 257465320, TRUE),
    (NULL, 2002019301, NULL, TRUE),
    ('LM9432', 1992008825, NULL, TRUE),
    (NULL, 2010049868, NULL, TRUE),
    ('LM9718', 1987000616, NULL, TRUE),
    (NULL, 2003019801, NULL, TRUE),
    ('LM9729', 1998009164, NULL, TRUE),
    (NULL, 2000013619, NULL, TRUE),
    ('LMFZ', 2003022205, 259281000, TRUE),
    ('LMFZ', 2021119177, 259281000, TRUE),
    ('LNAH', 1983002899, NULL, TRUE),
    ('LMBV', 2002019101, NULL, TRUE),
    ('LNSR', 1993010778, NULL, TRUE),
    (NULL, 1996010718, NULL, TRUE),
    ('LNYZ', 1985007410, 257435500, TRUE),
    ('LNYC', 1997005974, NULL, TRUE);

INSERT INTO
    fiskeridir_ais_vessel_mapping_whitelist (fiskeridir_vessel_id, mmsi, call_sign)
SELECT
    (ARRAY_AGG(f.fiskeridir_vessel_id)) [1],
    (ARRAY_AGG(a.mmsi)) [1],
    f.call_sign
FROM
    fiskeridir_vessels AS f
    LEFT JOIN ais_vessels AS a ON f.call_sign = a.call_sign
WHERE
    f.call_sign IS NOT NULL
    AND NOT (f.call_sign = ANY ('{00000000, 0}'))
GROUP BY
    f.call_sign
HAVING
    COUNT(*) = 1
ON CONFLICT DO NOTHING;

INSERT INTO
    fiskeridir_ais_vessel_mapping_whitelist (fiskeridir_vessel_id)
SELECT
    f.fiskeridir_vessel_id
FROM
    fiskeridir_vessels AS f
WHERE
    f.call_sign IS NULL
    OR f.call_sign = ANY ('{00000000, 0}')
ON CONFLICT DO NOTHING;
