CREATE INDEX ON landing_entries (line_number);

ALTER TABLE catch_locations
ADD COLUMN catch_area_id INT REFERENCES catch_areas (catch_area_id),
ADD COLUMN catch_main_area_id INT REFERENCES catch_main_areas (catch_main_area_id);

INSERT INTO
    catch_areas (catch_area_id, latitude, longitude)
VALUES
    (89, NULL, NULL), --MANUAL INSERTION
    (0, NULL, NULL),
    (1, 60.24815000000000, 4.500560000000000),
    (2, 60.76585000000000, 4.519880000000000),
    (3, 67.25000000000000, 11.50000000000000),
    (4, 72.50000000000000, 35.00000000000000),
    (5, 67.22556000000000, 13.53719000000000),
    (6, 62.75000000000000, 5.500000000000000),
    (7, 67.75000000000000, 10.50000000000000),
    (8, 57.75000000000000, 8.500000000000000),
    (9, 57.75000000000000, 9.500000000000000),
    (10, 67.82298000000000, 13.41423000000000),
    (11, 67.75442000000000, 14.53782000000000),
    (12, 58.26584000000000, 8.493570000000000),
    (13, 59.25000000000000, 3.500000000000000),
    (14, 58.25000000000000, 10.50000000000000),
    (15, 68.29821000000000, 13.44548000000000),
    (16, 58.75000000000000, 9.500000000000000),
    (17, 58.75000000000000, 10.50000000000000),
    (18, 63.25000000000000, 5.500000000000000),
    (19, 71.75000000000000, 29.50000000000000),
    (20, 59.25000000000000, 10.50000000000000),
    (21, 71.75000000000000, 31.50000000000000),
    (22, 63.75000000000000, 5.500000000000000),
    (23, 71.75000000000000, 26.50000000000000),
    (24, 58.75000000000000, 1.500000000000000),
    (25, 57.75000000000000, 7.500000000000000),
    (26, 71.13554000000001, 25.37756000000000),
    (27, 69.83414000000000, 21.79904000000000),
    (28, 69.75000000000000, 15.50000000000000),
    (29, 75.50000000000000, 12.00000000000000),
    (30, 55.25000000000000, 1.500000000000000),
    (31, 66.74865000000000, 12.50313000000000),
    (32, 69.25000000000000, -16.50000000000000),
    (33, 62.21811000000000, 5.597520000000000),
    (34, 59.25000000000000, 1.500000000000000),
    (35, 82.25000000000000, 39.00000000000000),
    (36, 70.75000000000000, 15.50000000000000),
    (37, 68.34791000000000, 17.20863000000000),
    (38, 61.33540000000000, 5.264680000000000),
    (39, 61.11448000000000, 6.788700000000000),
    (40, 57.25000000000000, -8.500000000000000),
    (41, 60.22739000000000, 5.380930000000000),
    (42, 59.75000000000000, -0.5000000000000000),
    (43, 59.75000000000000, 0.5000000000000000),
    (44, 68.27428000000000, 15.61145000000000),
    (45, 57.75000000000000, -10.50000000000000),
    (46, 68.15924000000000, 14.56579000000000),
    (47, 58.25000000000000, -13.50000000000000),
    (48, 68.08439000000000, 13.71385000000000),
    (49, 67.64251000000000, 12.74275000000000),
    (50, 60.25000000000000, -2.500000000000000),
    (51, 60.25000000000000, 2.500000000000000),
    (52, 60.75000000000000, 2.500000000000000),
    (53, 58.75000000000000, 2.500000000000000),
    (54, 59.25000000000000, 2.500000000000000),
    (55, 59.75000000000000, 2.500000000000000),
    (56, 58.25000000000000, -6.500000000000000),
    (57, 59.25000000000000, -15.50000000000000),
    (58, 61.50000000000000, -28.00000000000000),
    (59, 60.75000000000000, -3.500000000000000),
    (60, 60.75000000000000, -2.500000000000000),
    (61, 60.75000000000000, -1.500000000000000),
    (62, 60.75000000000000, -0.5000000000000000),
    (63, 58.75000000000000, -7.500000000000000),
    (64, 58.75000000000000, -6.500000000000000),
    (65, 56.75000000000000, 5.500000000000000),
    (66, 56.75000000000000, 6.500000000000000),
    (67, 56.75000000000000, 7.500000000000000),
    (68, 59.25000000000000, -10.50000000000000),
    (69, 61.25000000000000, -3.500000000000000),
    (70, 61.25000000000000, -2.500000000000000),
    (71, 59.25000000000000, -7.500000000000000),
    (72, 61.25000000000000, -0.5000000000000000),
    (73, 59.25000000000000, -5.500000000000000),
    (74, 61.25000000000000, 1.500000000000000),
    (75, 57.25000000000000, 5.500000000000000),
    (76, 57.25000000000000, 6.500000000000000),
    (77, 57.25000000000000, 7.500000000000000),
    (78, 59.75000000000000, -8.500000000000000),
    (79, 59.75000000000000, -7.500000000000000),
    (80, 59.75000000000000, -6.500000000000000),
    (81, 59.75000000000000, -5.500000000000000),
    (82, 59.75000000000000, -4.500000000000000),
    (83, 60.25000000000000, -4.500000000000000),
    (84, 61.75000000000000, 1.500000000000000),
    (85, 66.75000000000000, -30.50000000000000),
    (86, NULL, NULL),
    (87, NULL, NULL),
    (88, 66.75000000000000, -27.50000000000000),
    (90, 67.25000000000000, -31.50000000000000),
    (91, 67.25000000000000, -30.50000000000000),
    (92, 52.25000000000000, -16.50000000000000),
    (93, 52.25000000000000, -15.50000000000000),
    (94, 52.25000000000000, -14.50000000000000),
    (95, NULL, NULL),
    (96, NULL, NULL),
    (97, 52.25000000000000, -11.50000000000000),
    (98, NULL, NULL),
    (99, 62.75000000000000, -27.50000000000000)
ON CONFLICT (catch_area_id) DO NOTHING;

INSERT INTO
    catch_main_areas (catch_main_area_id, "name", latitude, longitude)
VALUES
    (
        --MANUAL INSERTION
        0,
        NULL,
        NULL,
        NULL
    ),
    (
        1,
        'Kaninbanken',
        68.70000000000000,
        49.00000000000000
    ),
    (
        2,
        'Murmanskkysten',
        69.24639999999999,
        36.76266000000000
    ),
    (
        3,
        'Øst-Finnmark',
        70.81682000000001,
        29.34360000000000
    ),
    (
        4,
        'Vest-Finnmark',
        70.64731000000000,
        20.84750000000000
    ),
    (
        5,
        'Røstbanken til Malangsgrunnen',
        69.02191999999999,
        14.44817000000000
    ),
    (
        6,
        'Helgelandsbanken',
        65.37965000000000,
        9.650350000000000
    ),
    (
        7,
        'Storegga-Frøyabanken',
        63.13230000000000,
        6.608180000000000
    ),
    (
        8,
        'Eigersundbanken',
        58.83315000000000,
        4.545130000000000
    ),
    (
        9,
        'Skagerrak',
        57.84350000000000,
        10.42851000000000
    ),
    (
        10,
        'Skolpenbanken',
        71.00000000000000,
        36.50000000000000
    ),
    (
        11,
        'Gåsebanken',
        70.93750000000000,
        48.12500000000000
    ),
    (
        12,
        'Nordkappbanken',
        72.55356999999999,
        22.10714000000000
    ),
    (
        13,
        'Thor Iversens Bank',
        73.00000000000000,
        35.00000000000000
    ),
    (
        14,
        'Britvinfeltet',
        73.03333000000001,
        47.53333000000000
    ),
    (
        15,
        'Sentralbanken',
        75.00000000000000,
        35.00000000000000
    ),
    (
        16,
        'Admiralityfeltet',
        75.02632000000000,
        49.52632000000000
    ),
    (
        17,
        'Nordøstområdet',
        79.25000000000000,
        45.50000000000000
    ),
    (18, NULL, 79.25000000000000, 59.50000000000000),
    (19, NULL, NULL, NULL),
    (
        20,
        'Bjørnøya',
        74.59921000000000,
        21.65873000000000
    ),
    (
        21,
        'Vest-Spitsbergen',
        77.02027000000000,
        9.948200000000000
    ),
    (
        22,
        'Storfjord/Hinlopenstredet',
        79.25781000000001,
        19.50000000000000
    ),
    (23, 'Hopen', 78.83481999999999, 26.16964000000000),
    (
        24,
        'Storbanken',
        79.25000000000000,
        35.00000000000000
    ),
    (
        25,
        'Nordv.- Spitsbergen',
        80.24008000000001,
        10.00595000000000
    ),
    (
        26,
        'Grønlandshavet',
        78.00000000000000,
        -4.000000000000000
    ),
    (
        27,
        'Sørvest av Spitsbergen',
        74.75000000000000,
        9.000000000000000
    ),
    (
        28,
        'Vikingbanken',
        61.04847000000000,
        4.513070000000000
    ),
    (29, NULL, NULL, NULL),
    (
        30,
        'Sørlige Norskehav',
        63.61111000000000,
        -1.611110000000000
    ),
    (
        31,
        'Øst av Færøyene',
        61.57353000000000,
        -5.558820000000000
    ),
    (32, NULL, NULL, NULL),
    (33, NULL, NULL, NULL),
    (
        34,
        'Sentrale Norskehav',
        66.50000000000000,
        -2.000000000000000
    ),
    (
        35,
        'Sør for Jan Mayen',
        69.50000000000000,
        -9.000000000000000
    ),
    (
        36,
        'Vestlige Norskehav',
        69.50000000000000,
        -2.000000000000000
    ),
    (
        37,
        'Østlige Norskehav',
        68.49444000000000,
        7.011110000000000
    ),
    (
        38,
        'Nordvestlige Norskehav',
        72.25000000000000,
        -4.000000000000000
    ),
    (
        39,
        'Vest av Tromsøflaket',
        72.25000000000000,
        9.000000000000000
    ),
    (
        40,
        'Sørlige Nordsjø',
        52.38060000000000,
        2.951850000000000
    ),
    (
        41,
        'Sentrale Nordsjø',
        55.54670000000000,
        3.280220000000000
    ),
    (
        42,
        'Shetland',
        59.75367000000000,
        -1.003490000000000
    ),
    (
        43,
        'Vest av Skottland (Hebridene)',
        57.39815000000000,
        -8.228400000000001
    ),
    (44, NULL, 53.49419000000000, -4.866280000000000),
    (45, NULL, NULL, NULL), --MANUAL INSERTION
    (
        46,
        'Utenfor Cornwall',
        49.97925000000000,
        -1.826330000000000
    ),
    (
        47,
        'Rockall',
        57.25000000000000,
        -15.00000000000000
    ),
    (
        48,
        'Vest av Irland',
        53.50346000000000,
        -13.41665000000000
    ),
    (
        49,
        'Sørvest av Irland',
        50.18056000000000,
        -11.92593000000000
    ),
    (
        50,
        'Sørvestlige Norskehav',
        65.50000000000000,
        -9.000000000000000
    ),
    (
        51,
        'Sørøst av Island',
        63.35461000000000,
        -15.29450000000000
    ),
    (
        52,
        'Sørvest av Island',
        63.35871000000000,
        -23.43255000000000
    ),
    (
        53,
        'Nordvest av Island',
        66.42263000000000,
        -24.82734000000000
    ),
    (
        54,
        'Nord av Horn  (Island)',
        66.74285999999999,
        -21.43841000000000
    ),
    (
        55,
        'Nord av Island',
        66.86435000000000,
        -18.54177000000000
    ),
    (
        56,
        'Nordøst av Island',
        67.15528000000000,
        -14.19542000000000
    ),
    (
        57,
        'Vest av Færøyene',
        61.60714000000000,
        -11.28571000000000
    ),
    (
        58,
        'Færøybanken',
        60.75000000000000,
        -9.000000000000000
    ),
    (
        59,
        'Øst av Island',
        65.52052999999999,
        -12.91464000000000
    ),
    (
        60,
        'Skjoldungen',
        60.98872000000000,
        -35.31391000000000
    ),
    (
        61,
        'Danmarkstredet',
        65.15164000000000,
        -33.54098000000000
    ),
    (
        62,
        'Gammelock',
        70.98672999999999,
        -20.52655000000000
    ),
    (64, NULL, NULL, NULL),
    (65, NULL, NULL, NULL),
    (66, 'Hellefiskbanken', NULL, NULL),
    (67, NULL, NULL, NULL),
    (68, 'Fyllas Bank', NULL, NULL),
    (69, NULL, NULL, NULL),
    (
        70,
        'Reykjanesryggen',
        54.28788000000000,
        -29.04545000000000
    ),
    (71, NULL, NULL, NULL),
    (74, NULL, NULL, NULL),
    (75, NULL, NULL, NULL),
    (76, 'Shetland', NULL, NULL),
    (78, 'Hamilton Bank', NULL, NULL),
    (80, NULL, NULL, NULL),
    (81, 'Flemish Cap', NULL, NULL),
    (82, NULL, NULL, NULL),
    (90, NULL, NULL, NULL),
    (96, NULL, NULL, NULL),
    (98, NULL, NULL, NULL),
    (
        99,
        'Atlanter-, Indiske- Stilleh. v/Antarktis',
        NULL,
        NULL
    )
ON CONFLICT (catch_main_area_id) DO NOTHING;

UPDATE catch_locations
SET
    catch_main_area_id = SPLIT_PART(catch_location_id, '-', 1)::INT,
    catch_area_id = SPLIT_PART(catch_location_id, '-', 2)::INT;

ALTER TABLE catch_locations
ALTER COLUMN catch_area_id
SET NOT NULL;

ALTER TABLE catch_locations
ALTER COLUMN catch_main_area_id
SET NOT NULL;

ALTER TABLE catch_locations
ADD UNIQUE (catch_main_area_id, catch_area_id);

CREATE
OR REPLACE FUNCTION add_to_landing_matrix () RETURNS TRIGGER LANGUAGE PLPGSQL AS $$
    BEGIN
        IF (TG_OP = 'INSERT') THEN
            IF (NEW.living_weight IS NOT NULL) THEN
                INSERT INTO
                    landing_matrix (
                        landing_id,
                        catch_location_id,
                        catch_location_matrix_index,
                        matrix_month_bucket,
                        vessel_length_group,
                        fiskeridir_vessel_id,
                        gear_group_id,
                        species_group_id,
                        living_weight
                    )
                SELECT
                    NEW.landing_id,
                    cl.catch_location_id,
                    cl.matrix_index,
                    HAULS_MATRIX_MONTH_BUCKET (l.landing_timestamp),
                    l.vessel_length_group_id,
                    l.fiskeridir_vessel_id,
                    l.gear_group_id,
                    NEW.species_group_id,
                    NEW.living_weight
                FROM
                    landing_entries e
                    INNER JOIN landings l ON l.landing_id = NEW.landing_id
                    INNER JOIN catch_locations cl ON l.catch_main_area_id = cl.catch_main_area_id
                    AND l.catch_area_id = cl.catch_area_id
                WHERE
                    e.landing_id = NEW.landing_id
                    AND e.line_number = NEW.line_number
                    AND HAULS_MATRIX_MONTH_BUCKET (l.landing_timestamp) >= 1999 * 12
                ON CONFLICT (landing_id, species_group_id) DO
                UPDATE
                SET
                    living_weight = landing_matrix.living_weight + excluded.living_weight;
            END IF;
        END IF;
        RETURN NEW;
   END;
$$;
