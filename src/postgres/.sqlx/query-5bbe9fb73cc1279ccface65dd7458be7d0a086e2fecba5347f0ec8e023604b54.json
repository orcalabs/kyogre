{
  "db_name": "PostgreSQL",
  "query": "\nWITH\n    everything AS (\n        SELECT\n            t.trip_id AS t_trip_id,\n            t.fiskeridir_vessel_id AS t_fiskeridir_vessel_id,\n            t.period AS t_period,\n            t.period_precision AS t_period_precision,\n            t.landing_coverage AS t_landing_coverage,\n            t.trip_assembler_id AS t_trip_assembler_id,\n            t.start_port_id AS t_start_port_id,\n            t.end_port_id AS t_end_port_id,\n            v.vessel_event_id AS v_vessel_event_id,\n            v.fiskeridir_vessel_id AS v_fiskeridir_vessel_id,\n            v.timestamp AS v_timestamp,\n            v.vessel_event_type_id AS v_vessel_event_type_id,\n            l.landing_id AS l_landing_id,\n            l.landing_timestamp AS l_landing_timestamp,\n            l.gear_id AS l_gear_id,\n            l.product_quality_id AS l_product_quality_id,\n            l.delivery_point_id AS l_delivery_point_id,\n            le.gross_weight AS le_gross_weight,\n            le.living_weight AS le_living_weight,\n            le.product_weight AS le_product_weight,\n            le.species_fiskeridir_id AS le_species_fiskeridir_id,\n            h.haul_id AS h_haul_id,\n            h.ers_activity_id AS h_ers_activity_id,\n            h.duration AS h_duration,\n            h.haul_distance AS h_haul_distance,\n            h.catch_location_start AS h_catch_location_start,\n            h.catch_locations AS h_catch_locations,\n            h.ocean_depth_end AS h_ocean_depth_end,\n            h.ocean_depth_start AS h_ocean_depth_start,\n            h.quota_type_id AS h_quota_type_id,\n            h.start_latitude AS h_start_latitude,\n            h.start_longitude AS h_start_longitude,\n            h.start_timestamp AS h_start_timestamp,\n            h.stop_timestamp AS h_stop_timestamp,\n            h.stop_latitude AS h_stop_latitude,\n            h.stop_longitude AS h_stop_longitude,\n            h.total_living_weight AS h_total_living_weight,\n            h.gear_id AS h_gear_id,\n            h.gear_group_id AS h_gear_group_id,\n            h.fiskeridir_vessel_id AS h_fiskeridir_vessel_id,\n            h.vessel_call_sign AS h_vessel_call_sign,\n            h.vessel_call_sign_ers AS h_vessel_call_sign_ers,\n            h.vessel_length AS h_vessel_length,\n            h.vessel_length_group AS h_vessel_length_group,\n            h.vessel_name AS h_vessel_name,\n            h.vessel_name_ers AS h_vessel_name_ers,\n            h.catches AS h_catches,\n            h.whale_catches AS h_whale_catches,\n            f.tool_id AS f_tool_id,\n            f.barentswatch_vessel_id AS f_barentswatch_vessel_id,\n            f.fiskeridir_vessel_id AS f_fiskeridir_vessel_id,\n            f.vessel_name AS f_vessel_name,\n            f.call_sign AS f_call_sign,\n            f.mmsi AS f_mmsi,\n            f.imo AS f_imo,\n            f.reg_num AS f_reg_num,\n            f.sbr_reg_num AS f_sbr_reg_num,\n            f.contact_phone AS f_contact_phone,\n            f.contact_email AS f_contact_email,\n            f.tool_type AS f_tool_type,\n            f.tool_type_name AS f_tool_type_name,\n            f.tool_color AS f_tool_color,\n            f.tool_count AS f_tool_count,\n            f.setup_timestamp AS f_setup_timestamp,\n            f.setup_processed_timestamp AS f_setup_processed_timestamp,\n            f.removed_timestamp AS f_removed_timestamp,\n            f.removed_processed_timestamp AS f_removed_processed_timestamp,\n            f.last_changed AS f_last_changed,\n            f.source AS f_source,\n            f.comment AS f_comment,\n            f.geometry_wkt AS f_geometry_wkt,\n            f.api_source AS f_api_source\n        FROM\n            trips t\n            LEFT JOIN vessel_events v ON t.trip_id = v.trip_id\n            LEFT JOIN landings l ON l.vessel_event_id = v.vessel_event_id\n            LEFT JOIN landing_entries le ON l.landing_id = le.landing_id\n            LEFT JOIN hauls h ON h.vessel_event_id = v.vessel_event_id\n            LEFT JOIN fishing_facilities f ON f.fiskeridir_vessel_id = t.fiskeridir_vessel_id\n            AND f.period && t.period\n        WHERE\n            t.fiskeridir_vessel_id = $1\n    )\nSELECT\n    q1.t_trip_id AS trip_id,\n    t_fiskeridir_vessel_id AS fiskeridir_vessel_id,\n    t_period AS period,\n    t_period_precision AS period_precision,\n    t_landing_coverage AS landing_coverage,\n    t_trip_assembler_id AS \"trip_assembler_id!: TripAssemblerId\",\n    t_start_port_id AS start_port_id,\n    t_end_port_id AS end_port_id,\n    total_gross_weight AS \"total_gross_weight!\",\n    total_living_weight AS \"total_living_weight!\",\n    total_product_weight AS \"total_product_weight!\",\n    num_deliveries AS \"num_deliveries!\",\n    gear_ids AS \"gear_ids!: Vec<Gear>\",\n    delivery_points AS \"delivery_points!\",\n    latest_landing_timestamp,\n    vessel_events::TEXT AS \"vessel_events!\",\n    hauls::TEXT AS \"hauls!\",\n    fishing_facilities::TEXT AS \"fishing_facilities!\",\n    COALESCE(catches, '[]')::TEXT AS \"catches!\"\nFROM\n    (\n        SELECT\n            t_trip_id,\n            t_fiskeridir_vessel_id,\n            t_period,\n            t_period_precision,\n            t_landing_coverage,\n            t_trip_assembler_id,\n            t_start_port_id,\n            t_end_port_id,\n            COALESCE(SUM(le_gross_weight), 0) AS total_gross_weight,\n            COALESCE(SUM(le_living_weight), 0) AS total_living_weight,\n            COALESCE(SUM(le_product_weight), 0) AS total_product_weight,\n            COUNT(DISTINCT l_landing_id) AS num_deliveries,\n            ARRAY_REMOVE(ARRAY_AGG(DISTINCT l_gear_id), NULL) AS gear_ids,\n            ARRAY_REMOVE(ARRAY_AGG(DISTINCT l_delivery_point_id), NULL) AS delivery_points,\n            MAX(l_landing_timestamp) AS latest_landing_timestamp,\n            COALESCE(\n                JSONB_AGG(\n                    JSONB_BUILD_OBJECT(\n                        'vessel_event_id',\n                        v_vessel_event_id,\n                        'fiskeridir_vessel_id',\n                        v_fiskeridir_vessel_id,\n                        'timestamp',\n                        v_timestamp,\n                        'vessel_event_type_id',\n                        v_vessel_event_type_id\n                    )\n                    ORDER BY\n                        v_timestamp\n                ),\n                '[]'\n            ) AS vessel_events,\n            COALESCE(\n                JSONB_AGG(\n                    JSONB_BUILD_OBJECT(\n                        'haul_id',\n                        h_haul_id,\n                        'ers_activity_id',\n                        h_ers_activity_id,\n                        'duration',\n                        h_duration,\n                        'haul_distance',\n                        h_haul_distance,\n                        'catch_location_start',\n                        h_catch_location_start,\n                        'catch_locations',\n                        h_catch_locations,\n                        'ocean_depth_end',\n                        h_ocean_depth_end,\n                        'ocean_depth_start',\n                        h_ocean_depth_start,\n                        'quota_type_id',\n                        h_quota_type_id,\n                        'start_latitude',\n                        h_start_latitude,\n                        'start_longitude',\n                        h_start_longitude,\n                        'start_timestamp',\n                        h_start_timestamp,\n                        'stop_timestamp',\n                        h_stop_timestamp,\n                        'stop_latitude',\n                        h_stop_latitude,\n                        'stop_longitude',\n                        h_stop_longitude,\n                        'total_living_weight',\n                        h_total_living_weight,\n                        'gear_id',\n                        h_gear_id,\n                        'gear_group_id',\n                        h_gear_group_id,\n                        'fiskeridir_vessel_id',\n                        h_fiskeridir_vessel_id,\n                        'vessel_call_sign',\n                        h_vessel_call_sign,\n                        'vessel_call_sign_ers',\n                        h_vessel_call_sign_ers,\n                        'vessel_length',\n                        h_vessel_length,\n                        'vessel_length_group',\n                        h_vessel_length_group,\n                        'vessel_name',\n                        h_vessel_name,\n                        'vessel_name_ers',\n                        h_vessel_name_ers,\n                        'catches',\n                        h_catches,\n                        'whale_catches',\n                        h_whale_catches\n                    )\n                ) FILTER (\n                    WHERE\n                        h_haul_id IS NOT NULL\n                ),\n                '[]'\n            ) AS hauls,\n            COALESCE(\n                JSONB_AGG(\n                    DISTINCT JSONB_BUILD_OBJECT(\n                        'tool_id',\n                        f_tool_id,\n                        'barentswatch_vessel_id',\n                        f_barentswatch_vessel_id,\n                        'fiskeridir_vessel_id',\n                        f_fiskeridir_vessel_id,\n                        'vessel_name',\n                        f_vessel_name,\n                        'call_sign',\n                        f_call_sign,\n                        'mmsi',\n                        f_mmsi,\n                        'imo',\n                        f_imo,\n                        'reg_num',\n                        f_reg_num,\n                        'sbr_reg_num',\n                        f_sbr_reg_num,\n                        'contact_phone',\n                        f_contact_phone,\n                        'contact_email',\n                        f_contact_email,\n                        'tool_type',\n                        f_tool_type,\n                        'tool_type_name',\n                        f_tool_type_name,\n                        'tool_color',\n                        f_tool_color,\n                        'tool_count',\n                        f_tool_count,\n                        'setup_timestamp',\n                        f_setup_timestamp,\n                        'setup_processed_timestamp',\n                        f_setup_processed_timestamp,\n                        'removed_timestamp',\n                        f_removed_timestamp,\n                        'removed_processed_timestamp',\n                        f_removed_processed_timestamp,\n                        'last_changed',\n                        f_last_changed,\n                        'source',\n                        f_source,\n                        'comment',\n                        f_comment,\n                        'geometry_wkt',\n                        ST_ASTEXT (f_geometry_wkt),\n                        'api_source',\n                        f_api_source\n                    )\n                ) FILTER (\n                    WHERE\n                        f_tool_id IS NOT NULL\n                ),\n                '[]'\n            ) AS fishing_facilities\n        FROM\n            everything\n        GROUP BY\n            t_trip_id,\n            t_fiskeridir_vessel_id,\n            t_period,\n            t_period_precision,\n            t_landing_coverage,\n            t_trip_assembler_id,\n            t_start_port_id,\n            t_end_port_id\n    ) q1\n    LEFT JOIN (\n        SELECT\n            qi.t_trip_id,\n            JSONB_AGG(qi.catches) AS catches\n        FROM\n            (\n                SELECT\n                    t_trip_id,\n                    JSONB_BUILD_OBJECT(\n                        'living_weight',\n                        COALESCE(SUM(le_living_weight), 0),\n                        'gross_weight',\n                        COALESCE(SUM(le_gross_weight), 0),\n                        'product_weight',\n                        COALESCE(SUM(le_product_weight), 0),\n                        'species_fiskeridir_id',\n                        le_species_fiskeridir_id,\n                        'product_quality_id',\n                        l_product_quality_id\n                    ) AS catches\n                FROM\n                    everything\n                WHERE\n                    l_product_quality_id IS NOT NULL\n                    AND le_species_fiskeridir_id IS NOT NULL\n                GROUP BY\n                    t_trip_id,\n                    l_product_quality_id,\n                    le_species_fiskeridir_id\n            ) qi\n        GROUP BY\n            qi.t_trip_id\n    ) q2 ON q1.t_trip_id = q2.t_trip_id\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "trip_id",
        "type_info": "Int8"
      },
      {
        "ordinal": 1,
        "name": "fiskeridir_vessel_id",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "period",
        "type_info": "TstzRange"
      },
      {
        "ordinal": 3,
        "name": "period_precision",
        "type_info": "TstzRange"
      },
      {
        "ordinal": 4,
        "name": "landing_coverage",
        "type_info": "TstzRange"
      },
      {
        "ordinal": 5,
        "name": "trip_assembler_id!: TripAssemblerId",
        "type_info": "Int4"
      },
      {
        "ordinal": 6,
        "name": "start_port_id",
        "type_info": "Varchar"
      },
      {
        "ordinal": 7,
        "name": "end_port_id",
        "type_info": "Varchar"
      },
      {
        "ordinal": 8,
        "name": "total_gross_weight!",
        "type_info": "Numeric"
      },
      {
        "ordinal": 9,
        "name": "total_living_weight!",
        "type_info": "Numeric"
      },
      {
        "ordinal": 10,
        "name": "total_product_weight!",
        "type_info": "Numeric"
      },
      {
        "ordinal": 11,
        "name": "num_deliveries!",
        "type_info": "Int8"
      },
      {
        "ordinal": 12,
        "name": "gear_ids!: Vec<Gear>",
        "type_info": "Int4Array"
      },
      {
        "ordinal": 13,
        "name": "delivery_points!",
        "type_info": "VarcharArray"
      },
      {
        "ordinal": 14,
        "name": "latest_landing_timestamp",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 15,
        "name": "vessel_events!",
        "type_info": "Text"
      },
      {
        "ordinal": 16,
        "name": "hauls!",
        "type_info": "Text"
      },
      {
        "ordinal": 17,
        "name": "fishing_facilities!",
        "type_info": "Text"
      },
      {
        "ordinal": 18,
        "name": "catches!",
        "type_info": "Text"
      }
    ],
    "parameters": {
      "Left": [
        "Int8"
      ]
    },
    "nullable": [
      false,
      false,
      false,
      true,
      false,
      false,
      true,
      true,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "5bbe9fb73cc1279ccface65dd7458be7d0a086e2fecba5347f0ec8e023604b54"
}
