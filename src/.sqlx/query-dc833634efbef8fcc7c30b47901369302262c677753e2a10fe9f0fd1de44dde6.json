{
  "db_name": "PostgreSQL",
  "query": "\nWITH\n    input AS (\n        SELECT\n            UNNEST($1::BIGINT[]) fiskeridir_vessel_id,\n            UNNEST($2::TIMESTAMPTZ[]) timestamp\n    ),\n    top AS (\n        SELECT DISTINCT\n            ON (i.fiskeridir_vessel_id, i.timestamp) i.fiskeridir_vessel_id AS fiskeridir_vessel_id,\n            i.timestamp AS deleted_timestamp,\n            f.timestamp AS end_ts,\n            f.fuel AS end_fuel\n        FROM\n            fuel_measurements f\n            INNER JOIN input i ON f.fiskeridir_vessel_id = i.fiskeridir_vessel_id\n            AND f.timestamp > i.timestamp\n        ORDER BY\n            i.fiskeridir_vessel_id,\n            i.timestamp,\n            f.timestamp ASC\n    ),\n    bottom AS (\n        SELECT DISTINCT\n            ON (i.fiskeridir_vessel_id, i.timestamp) i.fiskeridir_vessel_id AS fiskeridir_vessel_id,\n            i.timestamp AS deleted_timestamp,\n            f.timestamp AS start_ts,\n            f.fuel AS start_fuel,\n            f.fuel_after AS start_fuel_after\n        FROM\n            fuel_measurements f\n            INNER JOIN input i ON f.fiskeridir_vessel_id = i.fiskeridir_vessel_id\n            AND f.timestamp < i.timestamp\n        ORDER BY\n            i.fiskeridir_vessel_id,\n            i.timestamp,\n            f.timestamp DESC\n    )\nINSERT INTO\n    fuel_measurement_ranges (\n        fiskeridir_vessel_id,\n        start_measurement_ts,\n        start_measurement_fuel,\n        start_measurement_fuel_after,\n        end_measurement_ts,\n        end_measurement_fuel\n    )\nSELECT\n    t.fiskeridir_vessel_id,\n    b.start_ts,\n    b.start_fuel,\n    b.start_fuel_after,\n    t.end_ts,\n    t.end_fuel\nFROM\n    top t\n    INNER JOIN bottom b ON t.fiskeridir_vessel_id = b.fiskeridir_vessel_id\n    AND t.deleted_timestamp = b.deleted_timestamp\nWHERE\n    COMPUTE_FUEL_USED (b.start_fuel, b.start_fuel_after, t.end_fuel) > 0.0\n    --! This only occurs if 'add_fuel_measurement_ranges_post_measurement_insertion' is called prior to this method\n    --! then both will try to add the same fuel_measurement range\nON CONFLICT (fiskeridir_vessel_id, fuel_range) DO NOTHING\n            ",
  "describe": {
    "columns": [],
    "parameters": {
      "Left": [
        "Int8Array",
        "TimestamptzArray"
      ]
    },
    "nullable": []
  },
  "hash": "dc833634efbef8fcc7c30b47901369302262c677753e2a10fe9f0fd1de44dde6"
}
